<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GM Agency Official</title>
    <style>
        /* Pakistan Government Look */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }
        body {
            background: #f0f4f8;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        /* Pakistan Green Header */
        .header {
            background: #00401A;  /* Pakistan Green */
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 5px solid #FFFFFF;
        }
        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-area img {
            width: 60px;
            height: auto;
        }
        .govt-text {
            font-size: 14px;
            opacity: 0.9;
        }
        .contact {
            background: #FFFFFF22;
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid white;
        }
        /* Rest of the CSS - same as before but with Pakistan green theme */
        /* ... (baqi CSS previous solution jaisi hai lekin colors Pakistan green shade mein) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Pakistan Logo -->
        <div class="header">
            <div class="logo-area">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5b/State_emblem_of_Pakistan.svg" alt="Pakistan Logo">
                <div>
                    <h1>GM AGENCY OFFICIAL</h1>
                    <div class="govt-text">Government Registered | ERP v.1.1</div>
                </div>
            </div>
            <div class="contact">üìû 0302 3313131</div>
        </div>

        <!-- Inventory Section with Edit Prices -->
        <div class="inventory-section">
            <h2>üì¶ Current Stock & Prices</h2>
            <div class="inventory-grid" id="inventoryGrid">
                <!-- Data will load from Google Sheets -->
            </div>
            
            <!-- Add Stock Section -->
            <div class="add-stock-row">
                <h3>Add New Stock:</h3>
                <div id="addStockInputs"></div>
                <button onclick="addStock()" class="btn-primary">‚ûï Add to Inventory</button>
            </div>
            
            <!-- Live Profit Card -->
            <div class="profit-card" id="profitCard">
                <!-- Dynamic from Google Sheets -->
            </div>
        </div>

        <!-- Quick Expense + New Order -->
        <div class="two-column">
            <!-- Quick Expense -->
            <div class="card">
                <h3>üí∞ Quick Expense</h3>
                <input type="text" id="expDesc" placeholder="Description">
                <input type="number" id="expAmount" placeholder="Amount (Rs.)">
                <button onclick="addExpense()" class="btn-danger">Add Expense</button>
            </div>
            
            <!-- New Sales Order -->
            <div class="card">
                <h3>üõí Create New Sales Order</h3>
                <div class="sales-form">
                    <input type="date" id="saleDate">
                    
                    <!-- Customer Selection -->
                    <select id="customerSelect" onchange="loadCustomer()">
                        <option value="">-- Select Existing Customer --</option>
                    </select>
                    
                    <h4>OR Add New Customer:</h4>
                    <input type="text" id="customerName" placeholder="Full Name">
                    <input type="tel" id="customerPhone" placeholder="Phone Number">
                    <input type="text" id="customerAddress" placeholder="Address">
                    <input type="text" id="customerCity" placeholder="City">
                    
                    <!-- Item Quantities -->
                    <div class="items-grid" id="itemsGrid"></div>
                    
                    <!-- Totals -->
                    <div class="total-row">
                        <span>Total BDI:</span>
                        <span id="totalBdi">0</span>
                    </div>
                    <input type="number" id="cashReceived" placeholder="Cash Received" value="0">
                    
                    <button onclick="saveOrder()" class="btn-success">üíæ Save & Record Order</button>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="transactions-card">
            <h3>üìã Recent Transactions</h3>
            <div class="table-responsive">
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Phone</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Balance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionBody"></tbody>
                </table>
            </div>
            <div class="summary" id="summaryTotals"></div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/5b/State_emblem_of_Pakistan.svg" width="30">
            State Property: GM Agency Official | Ministry of Commerce | 0302 3313131
        </div>
    </div>

    <script>
        // Global variables
        let inventory = {};
        let customers = [];
        let transactions = [];
        let totals = {};
        
        // Prices aapke diye hue
        const PRICES = {
            Vanda: 1384,
            Mineral: 98,
            UMB: 327
        };
        
        // Load all data when page starts
        window.onload = function() {
            google.script.run.withSuccessHandler(displayData).getAllData();
        };
        
        function displayData(data) {
            inventory = data.inventory;
            customers = data.customers;
            transactions = data.transactions.list;
            totals = data.transactions.totals;
            
            updateInventoryDisplay();
            updateCustomerDropdown();
            updateTransactionsDisplay();
        }
        
        function updateInventoryDisplay() {
            let html = '';
            for (let item in inventory) {
                html += `
                    <div class="inventory-card">
                        <h3>${item}</h3>
                        <div class="stock">Stock: <span class="stock-count">${inventory[item].stock}</span></div>
                        <div class="price">Price: Rs. <span class="price-value">${inventory[item].price}</span>
                            <button onclick="editPrice('${item}')" class="edit-btn">‚úèÔ∏è Edit</button>
                        </div>
                    </div>
                `;
            }
            document.getElementById('inventoryGrid').innerHTML = html;
            
            // Add stock inputs
            let inputs = '';
            for (let item in inventory) {
                inputs += `
                    <div class="stock-input">
                        <label>${item}:</label>
                        <input type="number" id="add_${item}" value="0" min="0">
                    </div>
                `;
            }
            document.getElementById('addStockInputs').innerHTML = inputs;
            
            // Profit card
            document.getElementById('profitCard').innerHTML = `
                <div>Live Net Profit</div>
                <div class="profit-amount">Rs. ${totals.netProfit.toLocaleString()}</div>
                <div>Sales: Rs. ${totals.sales.toLocaleString()} | Expenses: Rs. ${totals.expenses.toLocaleString()}</div>
            `;
        }
        
        function editPrice(item) {
            let newPrice = prompt(`Enter new price for ${item}:`, inventory[item].price);
            if (newPrice && !isNaN(newPrice) && newPrice > 0) {
                google.script.run.withSuccessHandler(function(newInventory) {
                    inventory = newInventory;
                    updateInventoryDisplay();
                    alert('Price updated successfully!');
                }).updatePrice(item, parseInt(newPrice));
            }
        }
        
        function addStock() {
            let updates = {};
            for (let item in inventory) {
                let qty = parseInt(document.getElementById(`add_${item}`).value) || 0;
                if (qty > 0) {
                    updates[item] = qty;
                }
            }
            
            if (Object.keys(updates).length === 0) {
                alert('Please enter quantity to add');
                return;
            }
            
            // Update each item
            for (let item in updates) {
                google.script.run.withSuccessHandler(function(newInventory) {
                    inventory = newInventory;
                    updateInventoryDisplay();
                }).addStock(item, updates[item]);
            }
            alert('Stock added successfully!');
        }
        
        function addExpense() {
            let desc = document.getElementById('expDesc').value;
            let amount = parseInt(document.getElementById('expAmount').value);
            
            if (!desc || !amount) {
                alert('Please enter description and amount');
                return;
            }
            
            google.script.run.withSuccessHandler(function(newTransactions) {
                transactions = newTransactions.list;
                totals = newTransactions.totals;
                updateTransactionsDisplay();
                updateInventoryDisplay(); // profit update
                document.getElementById('expDesc').value = '';
                document.getElementById('expAmount').value = '';
                alert('Expense added');
            }).addExpense(desc, amount);
        }
        
        function updateCustomerDropdown() {
            let select = document.getElementById('customerSelect');
            let options = '<option value="">-- Select Existing Customer --</option>';
            customers.forEach(c => {
                options += `<option value="${c.name}" data-phone="${c.phone}" data-address="${c.address}" data-city="${c.city}">${c.name} (${c.phone})</option>`;
            });
            select.innerHTML = options;
        }
        
        function loadCustomer() {
            let select = document.getElementById('customerSelect');
            let selected = select.options[select.selectedIndex];
            if (selected.value) {
                document.getElementById('customerName').value = selected.value;
                document.getElementById('customerPhone').value = selected.dataset.phone;
                document.getElementById('customerAddress').value = selected.dataset.address;
                document.getElementById('customerCity').value = selected.dataset.city || '';
            }
        }
        
        function updateTransactionsDisplay() {
            let tbody = document.getElementById('transactionBody');
            let rows = '';
            
            transactions.slice(-10).reverse().forEach(t => {
                if (t.customer !== 'EXPENSE') {
                    rows += `
                        <tr>
                            <td>${t.date}</td>
                            <td>${t.customer}</td>
                            <td>${t.phone || ''}</td>
                            <td>${t.items}</td>
                            <td>Rs. ${t.total.toLocaleString()}</td>
                            <td>Rs. ${t.paid.toLocaleString()}</td>
                            <td>Rs. ${t.balance.toLocaleString()}</td>
                            <td>
                                <button onclick="sendWhatsApp('${t.customer}', '${t.phone}', ${t.total}, ${t.balance})" class="btn-wa">üì± WA</button>
                                <button onclick="printReceipt('${t.customer}', '${t.phone}', '${t.address}', '${t.date}', ${t.total}, ${t.paid}, ${t.balance})" class="btn-print">üñ®Ô∏è Print</button>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tbody.innerHTML = rows;
            
            document.getElementById('summaryTotals').innerHTML = `
                <span>Total Sales: Rs. ${totals.sales.toLocaleString()}</span>
                <span>Total Paid: Rs. ${totals.paid.toLocaleString()}</span>
                <span>Total Balance: Rs. ${totals.balance.toLocaleString()}</span>
            `;
        }
        
        function sendWhatsApp(name, phone, total, balance) {
            if (!phone) {
                alert('Phone number not available');
                return;
            }
            let message = `GM Agency Official\nCustomer: ${name}\nTotal: Rs. ${total}\nBalance: Rs. ${balance}\nThank you for your business!`;
            let url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }
        
        function printReceipt(name, phone, address, date, total, paid, balance) {
            let printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>GM Agency Receipt</title>
                    <style>
                        body { font-family: Arial; padding: 40px; }
                        .header { text-align: center; border-bottom: 2px solid #00401A; padding-bottom: 20px; }
                        .logo { width: 80px; }
                        .receipt { max-width: 800px; margin: 0 auto; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        td { padding: 10px; border-bottom: 1px solid #ddd; }
                        .total { font-size: 18px; font-weight: bold; }
                        .footer { margin-top: 40px; text-align: center; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="header">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/5b/State_emblem_of_Pakistan.svg" class="logo">
                            <h1>GM AGENCY OFFICIAL</h1>
                            <p>Government Registered | ERP v.1.1</p>
                        </div>
                        
                        <h2>Sales Receipt</h2>
                        <table>
                            <tr><td>Date:</td><td>${date}</td></tr>
                            <tr><td>Customer Name:</td><td>${name}</td></tr>
                            <tr><td>Phone:</td><td>${phone || 'N/A'}</td></tr>
                            <tr><td>Address:</td><td>${address || 'N/A'}</td></tr>
                            <tr><td>Total Amount:</td><td>Rs. ${total}</td></tr>
                            <tr><td>Paid:</td><td>Rs. ${paid}</td></tr>
                            <tr><td>Balance:</td><td>Rs. ${balance}</td></tr>
                        </table>
                        
                        <p class="total">Status: ${balance === 0 ? '‚úÖ Paid' : '‚è≥ Pending'}</p>
                        
                        <div class="footer">
                            <p>Thank you for your business!</p>
                            <p>Contact: 0302 3313131 | Ministry of Commerce</p>
                        </div>
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Calculate total function for sales form
        window.calculateTotal = function() {
            let vanda = parseInt(document.getElementById('vandaQty')?.value) || 0;
            let mineral = parseInt(document.getElementById('mineralQty')?.value) || 0;
            let umb = parseInt(document.getElementById('umbQty')?.value) || 0;
            
            let total = (vanda * 1384) + (mineral * 98) + (umb * 327);
            document.getElementById('totalBdi').innerText = total;
            return total;
        };
        
        // Save order function
        window.saveOrder = function() {
            let order = {
                date: document.getElementById('saleDate').value,
                customer: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                city: document.getElementById('customerCity').value,
                vandaQty: parseInt(document.getElementById('vandaQty')?.value) || 0,
                mineralQty: parseInt(document.getElementById('mineralQty')?.value) || 0,
                umbQty: parseInt(document.getElementById('umbQty')?.value) || 0,
                total: calculateTotal(),
                paid: parseInt(document.getElementById('cashReceived').value) || 0,
                isNewCustomer: !document.getElementById('customerSelect').value
            };
            
            order.balance = order.total - order.paid;
            
            // Count items
            let items = 0;
            if(order.vandaQty > 0) items++;
            if(order.mineralQty > 0) items++;
            if(order.umbQty > 0) items++;
            order.items = items + ' item(s)';
            
            if(!order.customer) {
                alert('Please enter customer name');
                return;
            }
            
            if(order.total <= 0) {
                alert('Please add items');
                return;
            }
            
            google.script.run.withSuccessHandler(function(result) {
                inventory = result.inventory;
                transactions = result.transactions.list;
                totals = result.transactions.totals;
                updateInventoryDisplay();
                updateTransactionsDisplay();
                
                // Reset form
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerAddress').value = '';
                document.getElementById('customerCity').value = '';
                document.getElementById('cashReceived').value = '0';
                document.getElementById('vandaQty').value = '0';
                document.getElementById('mineralQty').value = '0';
                document.getElementById('umbQty').value = '0';
                document.getElementById('totalBdi').innerText = '0';
                
                alert('Order saved successfully!');
            }).saveOrder(order);
        };
    </script>
</body>
</html> 
